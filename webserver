#!/usr/bin/env venv/bin/python

import yaml
from flask import Flask, request
from lib.const import CONFIG_PATH
from lib.datasources.utils import get_datasources
from lib.chain import Chain

app = Flask(__name__)

@app.route('/ask_ai', methods=['POST'])
def ask_ai():
    with open(CONFIG_PATH, 'r', encoding='utf8') as f:
        config = yaml.load(f, Loader=yaml.FullLoader)
    query = request.form.get('query')
    datasource = request.form.get('datasource')

    if query is None:
        return 'Query not specified', 400
    try:
        content = Chain(get_datasources(config)).ask(query, datasource)
    except ValueError:
        return 'Service unavailable', 400
    if not content:
        return 'Response unavailable', 500
    return content, 200

if __name__ == '__main__':
    app.run(debug=True)
